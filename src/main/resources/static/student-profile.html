<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Profile - Student</title>
    <link rel="stylesheet" href="/css/student-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Student Portal</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="/student/dashboard">Dashboard</a>
                <a href="/student-profile.html" class="active">My Profile</a>
                <a href="/student/logout">Logout</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h1>My Profile</h1>
            </header>

            <section class="content-form" style="max-width: 600px;">
                <div id="profile-message"></div>
                
                <form id="profile-form">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address (Read-only)</label>
                        <input type="email" id="email" readonly>
                    </div>
                    <div class="form-group">
                        <label for="department">Department (Read-only)</label>
                        <input type="text" id="department" readonly>
                    </div>

                    <hr style="margin: 30px 0;">
                    <h2>Change Password</h2>
                    
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="currentPassword">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password (leave blank to keep unchanged)</label>
                        <input type="password" id="newPassword" name="newPassword">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

<script>
    // --- ELEMENT SELECTORS ---
    const profileForm = document.getElementById('profile-form');
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const departmentInput = document.getElementById('department');
    const messageDiv = document.getElementById('profile-message');

    // --- LOAD PROFILE DATA ON PAGE LOAD ---
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/student/profile/data')
            .then(response => response.json())
            .then(data => {
                if(data) {
                    nameInput.value = data.name;
                    emailInput.value = data.email;
                    departmentInput.value = data.department;
                }
            })
            .catch(err => console.error("Failed to load profile data:", err));
    });

    // --- HANDLE FORM SUBMISSION ---
    profileForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const formData = {
            name: document.getElementById('name').value,
            currentPassword: document.getElementById('currentPassword').value,
            newPassword: document.getElementById('newPassword').value
        };

        fetch('/student/profile/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                messageDiv.innerHTML = `<p class="success">${data.message}</p>`;
                // Clear password fields after successful update
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } else {
                messageDiv.innerHTML = `<p class="error">${data.message}</p>`;
            }
        })
        .catch(err => {
            console.error("Failed to update profile:", err);
            messageDiv.innerHTML = `<p class="error">An error occurred while updating.</p>`;
        });
    });
</script>
</body>
</html>